<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Pemesanan Villa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="css/style.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;400&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <style>
        /* Style untuk total harga agar mirip input/label */
        .total-price-display {
            padding: .375rem .75rem;
            font-size: 1.25rem;
            line-height: 1.5;
            color: #28a745;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: .25rem;
            font-weight: bold;
            display: block;
            box-sizing: border-box;
        }
        /* Style untuk tampilan villa dan kamar yang dipilih */
        .selected-info-display {
            padding: .375rem .75rem;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: .25rem;
            font-size: 1rem;
            color: #495057;
        }
        .selected-info-display strong {
            color: #007bff;
        }
        /* Style untuk grup input nomor telepon */
        .input-group .input-group-prepend .input-group-text {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        .input-group .form-control:first-child {
            border-top-left-radius: .25rem;
            border-bottom-left-radius: .25rem;
        }
        /* Custom styles for the new resort detail section to mimic the image */
        .resort-detail-card {
            border-radius: .5rem;
        }
        .resort-detail-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: .5rem;
        }
        .resort-rating {
            font-size: 1.1rem;
            color: #007bff;
            font-weight: bold;
        }
        .resort-review-count {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .check-info-box {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: .25rem;
            padding: .75rem;
            margin-bottom: 1rem;
        }
        .check-info-box h6 {
            margin-bottom: .25rem;
        }
        .check-info-box small {
            color: #6c757d;
        }
        .room-type-display {
            font-size: 1.25rem;
            font-weight: 500;
            color: #343a40;
            margin-bottom: .5rem;
        }
        .room-stock {
            color: #dc3545; /* Red for "rooms left" */
            font-weight: bold;
            margin-bottom: 1rem;
        }
        .guest-details-list {
            list-style: none;
            padding-left: 0;
            margin-bottom: 1rem;
        }
        .guest-details-list li {
            margin-bottom: .5rem;
            color: #495057;
        }
        .guest-details-list li i {
            width: 20px;
            text-align: center;
            margin-right: .5rem;
            color: #007bff;
        }
        .price-section {
            border-top: 1px solid #dee2e6;
            padding-top: 1rem;
            margin-top: 1rem;
        }
        .original-price {
            text-decoration: line-through;
            color: #6c757d;
            font-size: 1rem;
        }
        .final-price {
            font-size: 1.75rem;
            font-weight: bold;
            color: #dc3545; /* Red for final price */
        }
        /* Ensure image fits the column */
        #roomImageDisplay {
            max-width: 100%;
            height: auto;
        }

        /* --- UPDATED: Style for "Kirim Pemesanan" button hover effect (popup) --- */
        .btn-primary {
            background-color: #D29F62 !important; /* Kuning (sesuai gambar subscribe) */
            border-color: #D29F62 !important; /* Kuning (sesuai gambar subscribe) */
            color: #000 !important; /* Warna teks hitam pekat */
            font-weight: bold !important; /* Membuat teks lebih tebal */
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease; /* Transisi halus */
            position: relative; /* Penting untuk efek transform */
            z-index: 1; /* Pastikan tombol berada di atas elemen lain saat popup */
        }

        .btn-primary:hover {
            background-color: #007bff !important; /* Biru */
            border-color: #007bff !important; /* Biru */
            color: #fff !important; /* Warna teks putih */
            transform: translateY(-3px); /* Geser sedikit ke atas */
            box-shadow: 0 8px 15px rgba(0, 123, 255, 0.4); /* Efek bayangan untuk "keluar" */
        }

        /* --- Style for Back to Top Button --- */
        .back-to-top {
            position: fixed;
            display: none; /* Akan diubah menjadi block oleh jQuery saat discroll */
            right: 30px;
            bottom: 30px;
            z-index: 99;
            border-radius: 0; /* Bentuk kotak */
            width: 46px; /* Ukuran sesuai btn-lg-square dari style.min.css */
            height: 46px; /* Ukuran sesuai btn-lg-square dari style.min.css */
            /* Menggunakan Flexbox untuk centering ikon */
            display: flex;
            align-items: center; /* Pusat vertikal */
            justify-content: center; /* Pusat horizontal */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s ease-in-out;
            background-color: #D29F62; /* Warna coklat keemasan dari style.css */
            color: #343a40; /* Warna gelap untuk ikon dari style.css */
        }
        .back-to-top:hover {
            background-color: #BF8C52; /* Warna hover coklat keemasan dari style.css */
            text-decoration: none;
        }
        /* --- END Style for Back to Top Button --- */
    </style>

</head>
<body>

    <div class="container-fluid page-header position-relative overlay-bottom">
        <div class="d-flex flex-column align-items-center justify-content-center pt-0 pt-lg-5" style="min-height: 400px">
            <h1 class="display-4 mb-3 mt-0 mt-lg-5 text-white text-uppercase">Form Pemesanan</h1>
            <div class="d-inline-flex mb-lg-5">
                <p class="m-0 text-white"><a class="text-white" href="index.html">Home</a></p>
                <p class="m-0 text-white px-2">/</p>
                <p class="m-0 text-white">Pemesanan Villa</p>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="container mb-5" style="max-width: 1200px;">
            <div class="row">
                <div class="col-lg-7 col-md-12 mb-4">
                    <div class="card shadow border-0">
                        <div class="card-body p-4">
                            <div id="alert-container"></div>

                            <form id="formPemesanan">
                                <div class="form-group">
                                    <label>Villa & Jenis Kamar yang Dipilih</label>
                                    <div id="selectedVillaRoomInfo" class="selected-info-display">
                                        Memuat informasi kamar...
                                    </div>
                                </div>

                                <h5 class="mb-3">Detail Kontak Anda</h5>
                                <p class="text-muted"><small>Mohon isi semua bidang dengan benar.</small></p>

                                <div class="form-group">
                                    <label for="nama">Nama Lengkap (Sesuai KTP/ID Resmi)</label>
                                    <input type="text" class="form-control" id="nama" required placeholder="Contoh: Andi Saputra">
                                    <small class="form-text text-muted">Mohon gunakan hanya huruf (A-Z), tanpa gelar, karakter khusus, dan tanda baca.</small>
                                </div>

                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label for="email">Email</label>
                                        <input type="email" class="form-control" id="email" required placeholder="Contoh: nama@example.com">
                                        <small class="form-text text-muted">Tuliskan e-mail pribadi anda.</small>
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label for="mobileNumber">Nomor Ponsel</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">+62</span>
                                            </div>
                                            <input type="tel" class="form-control" id="mobileNumber" required placeholder="Contoh: 81234567890">
                                        </div>
                                        <small class="form-text text-muted">Contoh: 81234567890.</small>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="guestType" id="iAmGuest" value="guest" checked>
                                        <label class="form-check-label" for="iAmGuest">Saya tamu yang menginap</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="guestType" id="bookingForAnother" value="another">
                                        <label class="form-check-label" for="bookingForAnother">Saya memesan untuk orang lain</label>
                                    </div>
                                </div>

                                <div id="actualGuestSection" style="display: none;">
                                    <hr class="my-4">
                                    <h5 class="mb-3">Detail Penginap Sebenarnya</h5>
                                    <p class="text-muted"><small>Mohon isi detail penginap yang sebenarnya akan menginap.</small></p>

                                    <div class="form-group">
                                        <label for="actualGuestNama">Nama Lengkap Penginap</label>
                                        <input type="text" class="form-control" id="actualGuestNama" placeholder="Contoh: Budi Santoso">
                                        <small class="form-text text-muted">Nama lengkap penginap sesuai KTP/ID Resmi.</small>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="actualGuestEmail">Email Penginap</label>
                                            <input type="email" class="form-control" id="actualGuestEmail" placeholder="Contoh: budi@example.com">
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label for="actualGuestMobileNumber">Nomor Ponsel Penginap</label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text">+62</span>
                                                </div>
                                                <input type="tel" class="form-control" id="actualGuestMobileNumber" placeholder="Contoh: 81123456789">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <hr class="my-4">

                                <h5 class="mb-3">Detail Menginap</h5>
                                <div class="form-group">
                                    <label for="checkin">Tanggal Check-In</label>
                                    <input type="date" class="form-control" id="checkin" required>
                                </div>
                                <div class="form-group">
                                    <label for="checkout">Tanggal Check-Out</label>
                                    <input type="date" class="form-control" id="checkout" required>
                                </div>

                                <div class="form-group">
                                    <label for="jumlahKamar">Jumlah Kamar</label>
                                    <input type="number" class="form-control" id="jumlahKamar" min="1" value="1" required placeholder="Misal: 1">
                                </div>

                                <small id="infoKamar" class="form-text text-muted mb-3"></small>

                                <div class="form-group">
                                    <label for="tamu">Jumlah Tamu (Total Dewasa & Anak-anak)</label>
                                    <input type="number" class="form-control" id="tamu" min="1" required placeholder="Misal: 4">
                                    <small id="kapasitasAlert" class="form-text text-danger" style="display: none;">Jumlah tamu melebihi kapasitas kamar yang dipilih!</small>
                                </div>

                                <div class="form-group">
                                    <label for="totalHargaDisplay" class="font-weight-bold">Total Harga Pemesanan</label>
                                    <div id="totalHargaDisplay" class="total-price-display"></div>
                                </div>

                                <div class="form-group">
                                    <label for="catatan">Catatan Tambahan</label>
                                    <textarea class="form-control" id="catatan" rows="3" placeholder="Contoh: Tambahan selimut, datang malam."></textarea>
                                </div>

                                <hr class="my-4">

                                <h5 class="mb-3">Metode Pembayaran</h5>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="metode" id="cash" value="cash" checked>
                                    <label class="form-check-label" for="cash">Cash (Bayar di tempat)</label>
                                </div>
                                <div class="form-check mb-4">
                                    <input class="form-check-input" type="radio" name="metode" id="qris" value="qris">
                                    <label class="form-check-label" for="qris">QRIS (Transfer Virtual)</label>
                                </div>

                                <div id="qrisSection" style="display: none;">
                                    <div class="text-center mb-3">
                                        <img src="img/QRIS.jpg" alt="QRIS" style="max-width: 260px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.08);">
                                        <p class="text-muted mt-2"><small>Silakan scan QRIS dan upload bukti transfer</small></p>
                                    </div>
                                    <div class="form-group">
                                        <label for="bukti">Upload Bukti Transfer</label>
                                        <input type="file" class="form-control-file" id="bukti" accept=".jpg,.png,.pdf">
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary btn-block mt-3">Kirim Pemesanan</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-lg-5 col-md-12 mb-4">
                    <div class="card shadow border-0 resort-detail-card">
                        <div class="card-body p-4">
                            <h4 class="resort-detail-header mb-1" id="resortNameDisplay">Baturraden Palawi Resort</h4>
                            <div class="d-flex align-items-center mb-3">
                                <span class="resort-rating mr-1" id="resortRatingDisplay">7.8</span>
                                <span class="resort-review-count" id="resortReviewCountDisplay">(18)</span>
                            </div>

                            <div class="mb-4 text-center">
                                <img src="img/FO EBONY.png" class="img-fluid rounded" alt="Villa/Room Image" id="roomImageDisplay" style="max-height: 200px; width: auto;">
                            </div>

                            <div class="d-flex justify-content-between check-info-box mb-3">
                                <div class="text-center">
                                    <h6 class="text-primary">Check-in</h6>
                                    <p class="mb-0" id="checkinDateDisplay"><strong>Tanggal Check-in</strong></p>
                                    <small>From 14:00</small>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="mx-2" id="nightsCountDisplay">1 night</span>
                                </div>
                                <div class="text-center">
                                    <h6 class="text-primary">Check-out</h6>
                                    <p class="mb-0" id="checkoutDateDisplay"><strong>Tanggal Check-out</strong></p>
                                    <small>Before 12:00</small>
                                </div>
                            </div>

                            <div class="room-type-display" id="roomTypeDetailsDisplay">(1x) Jenis Kamar - Fasilitas</div>
                            <p class="room-stock" style="display:none;">2 room(s) left!</p> <ul class="guest-details-list">
                                <li><i class="fas fa-user-friends"></i> <span id="guestCountDisplay">2 Guest</span></li>
                                <li><i class="fas fa-child"></i> <span>1 children</span></li> <li><i class="fas fa-bed"></i> <span>1 double bed</span></li> <li><i class="fas fa-utensils"></i> Breakfast Included</li>
                                <li><i class="fas fa-ticket-alt"></i> Free ONE_DAY_TOUR_TRIP</li>
                                <li><i class="fas fa-wifi"></i> Free WiFi</li>
                            </ul>

                            <div class="price-section text-right">
                                <div class="d-flex justify-content-between align-items-end mb-1" id="originalPriceRow" style="display:none;">
                                    <span class="text-muted">Total Room Price</span>
                                    <span class="original-price" id="originalPriceDisplay">Rp 466.665</span> </div>
                                <div class="d-flex justify-content-between align-items-end">
                                    <span class="text-muted small" id="roomsNightsSummary">1 room(s), 1 night(s)</span>
                                    <span class="final-price" id="finalPriceDisplay">Rp 350.000</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid footer text-white mt-5 pt-5 px-0 position-relative overlay-top">
        <div class="row mx-0 pt-5 px-sm-3 px-lg-5 mt-4">
            <div class="col-lg-3 col-md-6 mb-5">
                <h4 class="text-white text-uppercase mb-4" style="letter-spacing: 3px;">Get In Touch</h4>
                <p><i class="fa fa-map-marker-alt mr-2"></i>Jl. Bumi Perkemahan Wana Wisata, Dusun I Karangmangu, Kemutug Lor, Kec. Baturaden, Kabupaten Banyumas, Jawa Tengah 53151</p>
                <p><i class="fa fa-phone-alt mr-2"></i>0822-2689-2299 (Marketing Palawi)</p>
                <p class="m-0"><i class="fa fa-envelope mr-2"></i>klasterbanyumas@econique.co.id</p>
            </div>
            <div class="col-lg-3 col-md-6 mb-5">
                <h4 class="text-white text-uppercase mb-4" style="letter-spacing: 3px;">Follow Us</h4>
                <div class="d-flex justify-content-start">
                    <a class="btn btn-lg btn-outline-light btn-lg-square mr-2" href="#"><i
                                class="fab fa-twitter"></i></a>
                    <a class="btn btn-lg btn-outline-light btn-lg-square mr-2" href="#"><i
                                class="fab fa-facebook-f"></i></a>
                    <a class="btn btn-lg btn-outline-light btn-lg-square mr-2" href="#"><i
                                class="fab fa-linkedin-in"></i></a>
                    <a class="btn btn-lg btn-outline-light btn-lg-square"
                                href="#"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-5">
                <h4 class="text-white text-uppercase mb-4" style="letter-spacing: 3px;">Open Hours</h4>
                <div>
                    <h6 class="text-white text-uppercase">Setiap Hari</h6>
                    <p>06.00 AM - 16.00 PM</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-5">
                <h4 class="text-white text-uppercase mb-4" style="letter-spacing: 3px;">Subscribe</h4>
                <p>Subscribe us for further information</p>
                <div class="w-100">
                    <div class="input-group">
                        <input type="text" class="form-control border-light" style="padding: 25px;"
                                placeholder="Your Email">
                        <div class="input-group-append">
                            <button class="btn btn-primary font-weight-bold px-3">Subscribe</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid text-center text-white border-top mt-4 py-4 px-sm-3 px-md-5"
            style="border-color: rgba(256, 256, 256, .1) !important;">
            <p class="mb-2 text-white">Copyright 2024 © All Rights Reserved.</a></p>
            <p class="m-0 text-white">Made with ❤️ Kevin IT Support Klaster Banyumas</a></p>
        </div>
    </div>
    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="fa fa-angle-double-up"></i></a>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script>
        // --- Global Variables for Room Data from URL ---
        let currentVillaName = "";
        let currentRoomType = "";
        let currentRoomPrice = 0;
        let currentRoomCapacity = 0;

        // --- Elemen Form ---
        const form = document.getElementById("formPemesanan");
        const namaInput = document.getElementById("nama");
        const emailInput = document.getElementById("email");
        const mobileNumberInput = document.getElementById("mobileNumber");
        const iAmGuestRadio = document.getElementById("iAmGuest");
        const bookingForAnotherRadio = document.getElementById("bookingForAnother");

        // Actual Guest Details elements
        const actualGuestSection = document.getElementById("actualGuestSection");
        const actualGuestNamaInput = document.getElementById("actualGuestNama");
        const actualGuestEmailInput = document.getElementById("actualGuestEmail");
        const actualGuestMobileNumberInput = document.getElementById("actualGuestMobileNumber");


        const checkinInput = document.getElementById("checkin");
        const checkoutInput = document.getElementById("checkout");
        const jumlahKamarInput = document.getElementById("jumlahKamar");
        const tamuInput = document.getElementById("tamu");
        const catatanInput = document.getElementById("catatan");

        const cashRadio = document.getElementById("cash");
        const qrisRadio = document.getElementById("qris");
        const qrisSection = document.getElementById("qrisSection");
        const buktiInput = document.getElementById("bukti");

        // --- Elemen Display & Alert ---
        const selectedVillaRoomInfoDisplay = document.getElementById("selectedVillaRoomInfo");
        const infoKamarSmall = document.getElementById("infoKamar");
        const totalHargaDisplay = document.getElementById("totalHargaDisplay");
        const kapasitasAlert = document.getElementById("kapasitasAlert");
        const alertContainer = document.getElementById("alert-container");

        // --- Elemen Dynamic di Panel Kanan ---
        const resortNameDisplay = document.getElementById("resortNameDisplay");
        const resortRatingDisplay = document.getElementById("resortRatingDisplay");
        const resortReviewCountDisplay = document.getElementById("resortReviewCountDisplay");
        const roomImageDisplay = document.getElementById("roomImageDisplay");
        const checkinDateDisplay = document.getElementById("checkinDateDisplay");
        const checkoutDateDisplay = document.getElementById("checkoutDateDisplay");
        const nightsCountDisplay = document.getElementById("nightsCountDisplay");
        const roomTypeDetailsDisplay = document.getElementById("roomTypeDetailsDisplay");
        const guestCountDisplay = document.getElementById("guestCountDisplay");
        const roomsNightsSummary = document.getElementById("roomsNightsSummary");
        const finalPriceDisplay = document.getElementById("finalPriceDisplay");
        const originalPriceRow = document.getElementById("originalPriceRow"); // untuk harga coret

        // --- FUNGSI BARU: Mengatur tampilan detail penginap sebenarnya ---
        function toggleActualGuestDetails() {
            if (bookingForAnotherRadio.checked) {
                actualGuestSection.style.display = "block";
                actualGuestNamaInput.required = true;
                actualGuestEmailInput.required = true;
                actualGuestMobileNumberInput.required = true;
            } else {
                actualGuestSection.style.display = "none";
                actualGuestNamaInput.required = false;
                actualGuestEmailInput.required = false;
                actualGuestMobileNumberInput.required = false;
                // Clear values when hidden
                actualGuestNamaInput.value = "";
                actualGuestEmailInput.value = "";
                actualGuestMobileNumberInput.value = "";
            }
        }


        // --- FUNGSI UTAMA UNTUK UPDATE FORM & HARGA ---
        function calculateTotalPriceAndValidate() {
            // Validasi ini hanya jika URL parameter sudah diisi
            if (!currentVillaName || !currentRoomType) {
                totalHargaDisplay.textContent = "";
                infoKamarSmall.textContent = "";
                kapasitasAlert.style.display = "none";
                // Sembunyikan atau reset panel kanan jika tidak ada data dari URL
                resortNameDisplay.textContent = "Informasi Villa";
                roomTypeDetailsDisplay.textContent = "Silakan pilih kamar di halaman detail villa.";
                finalPriceDisplay.textContent = "";
                checkinDateDisplay.textContent = "";
                checkoutDateDisplay.textContent = "";
                nightsCountDisplay.textContent = "";
                guestCountDisplay.textContent = "";
                roomsNightsSummary.textContent = "";
                originalPriceRow.style.display = "none"; // Sembunyikan harga coret
                return;
            }

            const checkinDate = new Date(checkinInput.value);
            const checkoutDate = new Date(checkoutInput.value);

            checkoutInput.setCustomValidity('');

            // Update tanggal di panel kanan berdasarkan input form
            checkinDateDisplay.textContent = checkinInput.value ? new Date(checkinInput.value).toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' }) : 'Tanggal Check-in';
            checkoutDateDisplay.textContent = checkoutInput.value ? new Date(checkoutInput.value).toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' }) : 'Tanggal Check-out';


            // Validasi Tanggal
            if (checkinInput.value && checkoutInput.value) {
                if (checkinDate >= checkoutDate) {
                    checkoutInput.setCustomValidity('Tanggal Check-out harus setelah Tanggal Check-in.');
                    totalHargaDisplay.textContent = "";
                    nightsCountDisplay.textContent = "0 night"; // Update nights display
                    roomsNightsSummary.textContent = `${jumlahKamarInput.value || 0} room(s), 0 night(s)`;
                    form.reportValidity();
                    return;
                }
            }

            let jumlahMalam = 0;
            if (checkinInput.value && checkoutInput.value && checkinDate < checkoutDate) {
                const diffTime = Math.abs(checkoutDate - checkinDate);
                jumlahMalam = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            }
            nightsCountDisplay.textContent = `${jumlahMalam} night${jumlahMalam > 1 ? 's' : ''}`; // Update nights display


            const hargaPerMalam = currentRoomPrice;
            const kapasitasPerKamar = currentRoomCapacity;

            const jumlahKamar = parseInt(jumlahKamarInput.value || 0);
            const jumlahTamu = parseInt(tamuInput.value || 0);

            // Perbarui info kamar (kapasitas dan harga per malam)
            infoKamarSmall.textContent = `Kapasitas: ${kapasitasPerKamar} Orang per kamar. Harga per Malam: Rp ${new Intl.NumberFormat('id-ID').format(hargaPerMalam)}.`;

            let total = 0;
            // Hanya hitung total jika semua input yang relevan memiliki nilai valid
            if (hargaPerMalam > 0 && jumlahMalam > 0 && jumlahKamar > 0) {
                total = hargaPerMalam * jumlahMalam * jumlahKamar;
            }

            // Update total harga display (form)
            if (total === 0) {
                totalHargaDisplay.textContent = "";
            } else {
                totalHargaDisplay.textContent = "Rp " + new Intl.NumberFormat('id-ID').format(total);
            }

            // Update harga final di panel kanan
            finalPriceDisplay.textContent = total > 0 ? "Rp " + new Intl.NumberFormat('id-ID').format(total) : "";

            // Update summary rooms and nights below final price in right panel
            roomsNightsSummary.textContent = `${jumlahKamar} room(s), ${jumlahMalam} night${jumlahMalam > 1 ? 's' : ''}`;


            // Validasi Kapasitas Tamu
            if (kapasitasPerKamar > 0 && jumlahTamu > (kapasitasPerKamar * jumlahKamar)) {
                kapasitasAlert.style.display = "block";
                tamuInput.setCustomValidity(`Jumlah tamu (${jumlahTamu}) melebihi kapasitas total (${kapasitasPerKamar * jumlahKamar} orang) untuk jumlah kamar yang dipilih.`);
                form.reportValidity();
            } else {
                kapasitasAlert.style.display = "none";
                tamuInput.setCustomValidity('');
            }
        }

        // --- Fungsi untuk menampilkan/menyembunyikan bagian QRIS ---
        function updateMetode() {
            if (qrisRadio.checked) {
                qrisSection.style.display = "block";
                buktiInput.required = true;
            } else {
                qrisSection.style.display = "none";
                buktiInput.required = false;
                buktiInput.value = "";
            }
        }

        // --- Event Listeners ---
        checkinInput.addEventListener("change", calculateTotalPriceAndValidate);
        checkoutInput.addEventListener("change", calculateTotalPriceAndValidate);
        jumlahKamarInput.addEventListener("change", calculateTotalPriceAndValidate);
        tamuInput.addEventListener("change", calculateTotalPriceAndValidate);
        tamuInput.addEventListener("keyup", calculateTotalPriceAndValidate);

        cashRadio.addEventListener("change", updateMetode);
        qrisRadio.addEventListener("change", updateMetode);

        // Event listeners for guest type radio buttons
        iAmGuestRadio.addEventListener("change", toggleActualGuestDetails);
        bookingForAnotherRadio.addEventListener("change", toggleActualGuestDetails);


        // --- Inisialisasi Saat Halaman Dimuat ---
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            currentVillaName = urlParams.get('villa') ? decodeURIComponent(urlParams.get('villa')) : '';
            currentRoomType = urlParams.get('roomType') ? decodeURIComponent(urlParams.get('roomType')) : '';
            currentRoomPrice = urlParams.get('price') ? parseFloat(urlParams.get('price')) : 0;
            currentRoomCapacity = urlParams.get('capacity') ? parseInt(urlParams.get('capacity')) : 0;

            if (currentVillaName && currentRoomType) {
                selectedVillaRoomInfoDisplay.innerHTML = `Villa: <strong>${currentVillaName}</strong> / Jenis Kamar: <strong>${currentRoomType}</strong>`;
                tamuInput.min = 1;

                // Update dynamic content in the right panel
                resortNameDisplay.textContent = currentVillaName;
                roomTypeDetailsDisplay.textContent = `(1x) ${currentRoomType}`; // Disini hanya menampilkan jenis kamar, karena fasilitas spesifik tidak diteruskan
                guestCountDisplay.textContent = `${currentRoomCapacity} Guest`;
                finalPriceDisplay.textContent = "Rp " + new Intl.NumberFormat('id-ID').format(currentRoomPrice); // Initial price display

                // Set default dates based on today + 1 and today + 2
                const today = new Date();
                const defaultCheckin = new Date(today);
                defaultCheckin.setDate(today.getDate() + 1);
                const defaultCheckout = new Date(today);
                defaultCheckout.setDate(today.getDate() + 2);

                checkinInput.value = defaultCheckin.toISOString().split('T')[0];
                checkoutInput.value = defaultCheckout.toISOString().split('T')[0];


            } else {
                selectedVillaRoomInfoDisplay.innerHTML = `<span class="text-danger">Informasi Villa dan Jenis Kamar tidak ditemukan.</span>`;
                form.querySelector('button[type="submit"]').disabled = true;
                namaInput.required = false;
                emailInput.required = false;
                mobileNumberInput.required = false;
                checkinInput.required = false;
                checkoutInput.required = false;
                jumlahKamarInput.required = false;
                tamuInput.required = false;

                // Reset/hide dynamic content in the right panel if no data from URL
                resortNameDisplay.textContent = "Informasi Villa";
                resortRatingDisplay.textContent = "";
                resortReviewCountDisplay.textContent = "";
                roomImageDisplay.src = ""; // Clear image
                checkinDateDisplay.textContent = "Tanggal Check-in";
                checkoutDateDisplay.textContent = "Tanggal Check-out";
                nightsCountDisplay.textContent = "";
                roomTypeDetailsDisplay.textContent = "Silakan pilih kamar di halaman detail villa.";
                guestCountDisplay.textContent = "";
                roomsNightsSummary.textContent = "";
                finalPriceDisplay.textContent = "";
                originalPriceRow.style.display = "none"; // Sembunyikan harga coret

                alertContainer.innerHTML = `
                    <div class="alert alert-danger fade show mt-3" role="alert">
                        <strong>Kesalahan!</strong><br>
                        Halaman ini harus diakses dari halaman detail villa dengan pilihan kamar.
                    </div>
                `;
                 $('html, body').animate({scrollTop: alertContainer.offsetTop - 50}, 500, 'easeOutExpo');
                 return;
            }

            updateMetode();
            toggleActualGuestDetails(); // Set initial state of actual guest details
            calculateTotalPriceAndValidate(); // Hitung total harga awal dan perbarui panel kanan
        });

        // --- Submit Form Listener ---
        form.addEventListener("submit", function (e) {
            e.preventDefault();
            alertContainer.innerHTML = "";

            calculateTotalPriceAndValidate();
            if (!form.checkValidity()) {
                form.reportValidity();
                $('html, body').animate({scrollTop: alertContainer.offsetTop - 50}, 500, 'easeOutExpo');
                return;
            }

            if (totalHargaDisplay.textContent === "") {
                const errorAlert = document.createElement("div");
                errorAlert.className = "alert alert-danger alert-dismissible fade show mt-3";
                errorAlert.role = "alert";
                errorAlert.innerHTML = `
                    <strong>Peringatan!</strong><br>
                    Mohon lengkapi semua detail pemesanan (tanggal, jumlah kamar, jumlah tamu) untuk menghitung total harga.
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                `;
                alertContainer.appendChild(errorAlert);
                $('html, body').animate({scrollTop: alertContainer.offsetTop - 50}, 500, 'easeOutExpo');
                return;
            }

            const jenisKamarDipilihText = currentRoomType;
            const jumlahKamarDipilih = jumlahKamarInput.value;
            const jumlahMalamMenginap = Math.ceil((new Date(checkoutInput.value) - new Date(checkinInput.value)) / (1000 * 60 * 60 * 24));
            const totalHargaFinal = totalHargaDisplay.textContent;
            const jumlahTamuFinal = tamuInput.value;
            const metode = qrisRadio.checked ? "QRIS" : "Cash";
            const guestType = iAmGuestRadio.checked ? "Saya tamu yang menginap" : "Saya memesan untuk orang lain";

            // Get actual guest details if provided
            let actualGuestDetails = "";
            if (bookingForAnotherRadio.checked) {
                actualGuestDetails = `
                    <br><strong>Detail Penginap Sebenarnya:</strong><br>
                    Nama Penginap: <strong>${actualGuestNamaInput.value}</strong><br>
                    Email Penginap: <strong>${actualGuestEmailInput.value}</strong><br>
                    Nomor Ponsel Penginap: <strong>+62${actualGuestMobileNumberInput.value}</strong>
                `;
            }

            const alertBox = document.createElement("div");
            alertBox.className = "alert alert-success alert-dismissible fade show mt-3";
            alertBox.role = "alert";
            alertBox.innerHTML = `
                <strong>Pemesanan Villa ${currentVillaName} berhasil dikirim!</strong><br>
                Nama: <strong>${namaInput.value}</strong><br>
                Email: <strong>${emailInput.value}</strong><br>
                Nomor Ponsel: <strong>+62${mobileNumberInput.value}</strong><br>
                Tipe Tamu: <strong>${guestType}</strong>${actualGuestDetails}<br>
                Check-in: <strong>${checkinInput.value}</strong><br>
                Check-out: <strong>${checkoutInput.value}</strong><br>
                Jumlah Malam: <strong>${jumlahMalamMenginap}</strong><br>
                Jumlah Kamar: <strong>${jumlahKamarDipilih}</strong><br>
                Jenis Kamar: <strong>${jenisKamarDipilihText}</strong><br>
                Jumlah Tamu: <strong>${jumlahTamuFinal}</strong><br>
                Metode Pembayaran: <strong>${metode}</strong><br>
                Total Harga: <strong>${totalHargaFinal}</strong><br>
                Silakan tunggu konfirmasi dari admin.
                <button type="button" class="close" data-dismiss="alert">&times;</button>
            `;
            alertContainer.appendChild(alertBox);

            form.reset();
            updateMetode();
            toggleActualGuestDetails(); // Reset visibility of actual guest details

            // Karena form.reset() menghapus nilai input, kita perlu mengatur ulang variabel global
            // dan tampilan agar konsisten dengan status "tidak ada pilihan"
            currentVillaName = "";
            currentRoomType = "";
            currentRoomPrice = 0;
            currentRoomCapacity = 0;

            // Set ulang tampilan panel kiri dan kanan
            resortNameDisplay.textContent = "Informasi Villa";
            selectedVillaRoomInfoDisplay.innerHTML = `<span class="text-danger">Silakan kembali ke halaman detail villa untuk memilih kamar.</span>`;
            infoKamarSmall.textContent = "";
            totalHargaDisplay.textContent = "";
            form.querySelector('button[type="submit"]').disabled = true;
            namaInput.required = false;
            emailInput.required = false;
            mobileNumberInput.required = false;
            checkinInput.required = false;
            checkoutInput.required = false;
            jumlahKamarInput.required = false;
            tamuInput.required = false;

            // Reset/hide dynamic content in the right panel
            resortNameDisplay.textContent = "Informasi Villa";
            resortRatingDisplay.textContent = "";
            resortReviewCountDisplay.textContent = "";
            roomImageDisplay.src = ""; // Clear image
            checkinDateDisplay.textContent = "Tanggal Check-in";
            checkoutDateDisplay.textContent = "Tanggal Check-out";
            nightsCountDisplay.textContent = "";
            roomTypeDetailsDisplay.textContent = "Silakan pilih kamar di halaman detail villa.";
            guestCountDisplay.textContent = "";
            roomsNightsSummary.textContent = "";
            finalPriceDisplay.textContent = "";
            originalPriceRow.style.display = "none"; // Sembunyikan harga coret

            // Scroll ke atas setelah pemesanan berhasil
            $('html, body').animate({scrollTop: 0}, 1500, 'easeOutExpo');
        });

        // JavaScript untuk Back to Top (jQuery)
        $(window).scroll(function () {
            if ($(this).scrollTop() > 100) {
                $('.back-to-top').fadeIn('slow');
            } else {
                $('.back-to-top').fadeOut('slow');
            }
        });
        $('.back-to-top').click(function () {
            $('html, body').animate({scrollTop: 0}, 1500, 'easeInOutExpo');
            return false;
        });
    </script>
</body>
</html>